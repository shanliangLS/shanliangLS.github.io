<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Node.js 编译时内存溢出 | 钐椋的博客</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.2.0"></head><body><header><nav><a href="/">首页</a><a href="/archives/">归档</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2020-10-23T03:17:34.000Z" id="date"> 2020-10-23</time></span><br><span>updated:<time datetime="2021-05-14T05:38:46.463Z" id="updated"> 2021-05-14</time></span></div><h1>Node.js 编译时内存溢出</h1><hr></div><div id="post-content"><h2 id="编译-Vuepress-内存溢出"><a href="#编译-Vuepress-内存溢出" class="headerlink" title="编译 Vuepress 内存溢出"></a>编译 Vuepress 内存溢出</h2><ul>
<li><input checked="" disabled="" type="checkbox"> 已解决</li>
</ul>
<p>在服务器上编译一个 Vuepress 项目时报错。之前都没出事，自从加了一堆 pdf 使得项目变得很大后就有问题了</p>
<p>在自己主机上怎么跑怎么编译都不会报错，放到服务器上老编译失败，可能是主机 64G 内存无所畏惧？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">wait</span> Rendering static HTML...<br>&lt;--- Last few GCs ---&gt;<br>[34421:0x3ae1f20]   238228 ms: Scavenge 2031.6 (2059.1) -&gt; 2027.7 (2076.9) MB, 8.0 / 0.0 ms  (average mu = 0.286, current mu = 0.319) allocation failure <br>&lt;--- JS stacktrace ---&gt;<br>==== JS stack trace =========================================<br>    0: ExitFrame [pc: 0x13cf019]<br>Security context: 0x1ba0e4d008d1 &lt;JSObject&gt;<br>    1: match [0x1ba0e4d0cb21](this=0x1bed81673269 &lt;String[36]: <span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">Boolean</span></span>() &#123; [native code] &#125;&gt;,0x1bed81673289 &lt;JSRegExp &lt;String[<span class="hljs-comment">#18]: ^\s*function (\w+)&gt;&gt;)</span><br>    2: assertProp(aka assertProp) [0x81163b025b9] [/home/gitlab-runner/builds/dQQYXgCs/0/infra/hello/node_modules/vue/dist/vue.runtime.common.dev.js:~1669] [pc=0x2d9c37a147d2](this=0x129b621404b1 &lt;undefi...<br><mark>FATAL ERROR: Ineffective mark-compacts near heap <span class="hljs-built_in">limit</span> Allocation failed - JavaScript heap out of memory</mark><br> 1: 0xa093f0 node::Abort() [node]<br> 2: 0xa097fc node::OnFatalError(char const*, char const*) [node]<br> 3: 0xb842ae v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]<br> 4: 0xb84629 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]<br> 5: 0xd30fe5  [node]<br> 6: 0xd31676 v8::internal::Heap::RecomputeLimits(v8::internal::GarbageCollector) [node]<br> 7: 0xd3def5 v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [node]<br> 8: 0xd3eda5 v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [node]<br> 9: 0xd4044f v8::internal::Heap::HandleGCRequest() [node]<br>10: 0xceef35 v8::internal::StackGuard::HandleInterrupts() [node]<br>11: 0x1049bf6 v8::internal::Runtime_StackGuard(int, unsigned long*, v8::internal::Isolate*) [node]<br>12: 0x13cf019  [node]<br>/home/gitlab-runner/builds/dQQYXgCs/0/infra/hello/node_modules/.bin/vuepress: line 14: 34421 Aborted                 node <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>/../vuepress/cli.js&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br>npm ERR! code ELIFECYCLE<br>npm ERR! errno 134<br>npm ERR! hello@1.0.0 docs:build: `vuepress build docs`<br>npm ERR! Exit status 134<br>npm ERR! <br>npm ERR! Failed at the hello@1.0.0 docs:build script.<br>npm ERR! This is probably not a problem with npm. There is likely additional logging output above.<br>npm ERR! A complete <span class="hljs-built_in">log</span> of this run can be found <span class="hljs-keyword">in</span>:<br>npm ERR!     /home/gitlab-runner/.npm/_logs/2020-10-19T00_37_45_861Z-debug.log<br>ERROR: Job failed: <span class="hljs-built_in">exit</span> status 1<br></code></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">wait</span> Rendering static HTML...<br>&lt;--- Last few GCs ---&gt;<br>[7124:0x4537f20]   248604 ms: Scavenge 2035.8 (2060.2) -&gt; 2030.6 (2060.9) MB, 5.5 / 0.0 ms  (average mu = 0.201, current mu = 0.099) allocation failure <br>[7124:0x4537f20]   249430 ms: Mark-sweep 2037.1 (2060.9) -&gt; 2032.2 (2074.7) MB, 765.0 / 0.0 ms  (average mu = 0.196, current mu = 0.190) allocation failure scavenge might not succeed<br>&lt;--- JS stacktrace ---&gt;<br>==== JS stack trace =========================================<br>    0: ExitFrame [pc: 0x13cf019]<br>Security context: 0x2cb4145808d1 &lt;JSObject&gt;<br>    1: resolveItem(aka resolveItem) [0x16f037ec6699] [1.server-bundle.js:~1745] [pc=0x29b9042c90cf](this=0x2b4191e004b1 &lt;undefined&gt;,0x29c6f54fbe91 &lt;String[<span class="hljs-comment">#17]\: 72-\x4f7f\x7528cordova\x63d2\x4ef6api&gt;,0x37e1826f1cc1 &lt;JSArray[535]&gt;,0x29c6f54f32b1 &lt;String[#38]: /doc/web/ionic/learning_ionic_chinese/&gt;)</span><br>    2: arguments adaptor frame: 4-&gt;3<br>    3: resolveItem(aka reso...<br><mark>FATAL ERROR: Ineffective mark-compacts near heap <span class="hljs-built_in">limit</span> Allocation failed - JavaScript heap out of memory</mark><br> 1: 0xa093f0 node::Abort() [node]<br> 2: 0xa097fc node::OnFatalError(char const*, char const*) [node]<br> 3: 0xb842ae v8::Utils::ReportOOMFailure(v8::internal::Isolate*, char const*, bool) [node]<br> 4: 0xb84629 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*, char const*, bool) [node]<br> 5: 0xd30fe5  [node]<br> 6: 0xd31676 v8::internal::Heap::RecomputeLimits(v8::internal::GarbageCollector) [node]<br> 7: 0xd3def5 v8::internal::Heap::PerformGarbageCollection(v8::internal::GarbageCollector, v8::GCCallbackFlags) [node]<br> 8: 0xd3eda5 v8::internal::Heap::CollectGarbage(v8::internal::AllocationSpace, v8::internal::GarbageCollectionReason, v8::GCCallbackFlags) [node]<br> 9: 0xd4044f v8::internal::Heap::HandleGCRequest() [node]<br>10: 0xceef35 v8::internal::StackGuard::HandleInterrupts() [node]<br>11: 0x1049bf6 v8::internal::Runtime_StackGuard(int, unsigned long*, v8::internal::Isolate*) [node]<br>12: 0x13cf019  [node]<br>/home/gitlab-runner/builds/dQQYXgCs/0/infra/hello/node_modules/.bin/vuepress: line 14:  7124 Aborted                 node <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>/../vuepress/cli.js&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br>npm ERR! code ELIFECYCLE<br>npm ERR! errno 134<br>npm ERR! hello@1.0.0 docs:build: `vuepress build docs`<br>npm ERR! Exit status 134<br>npm ERR! <br>npm ERR! Failed at the hello@1.0.0 docs:build script.<br>npm ERR! This is probably not a problem with npm. There is likely additional logging output above.<br>npm ERR! A complete <span class="hljs-built_in">log</span> of this run can be found <span class="hljs-keyword">in</span>:<br>npm ERR!     /home/gitlab-runner/.npm/_logs/2020-10-09T08_06_30_758Z-debug.log<br>ERROR: Job failed: <span class="hljs-built_in">exit</span> status 1<br></code></pre></td></tr></table></figure>

<p>主要错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">FATAL ERROR: Ineffective mark-compacts near heap <span class="hljs-built_in">limit</span> Allocation failed - JavaScript heap out of memory<br></code></pre></td></tr></table></figure>

<p>原因</p>
<p>node 基于 V8 引擎，限制了内存使用大小。在 V8 下，64 位系统可以操纵 1.4GB 的内存，32 位可以操纵 0.7GB 内存。如果前端项目非常庞大，webpack 编译时会占用很多的系统资源，如果超出了 V8 对 node 默认的内存限制大小就会出现如上的错误</p>
<h3 id="方案一：修改-NODE-OPTIONS"><a href="#方案一：修改-NODE-OPTIONS" class="headerlink" title="方案一：修改 NODE_OPTIONS"></a>方案一：修改 <code>NODE_OPTIONS</code></h3><p>在服务器上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> NODE_OPTIONS=--max_old_space_size=8192<br></code></pre></td></tr></table></figure>

<p>第一次出错时的解决方案，运行该命令后 <code>docs:build</code> 编译成功</p>
<p>一周后新增文档时再次出现报错，再加大 <code>--max_old_space_size=12288</code> 已无效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">242847 ms: Mark-sweep 2041.0 (2058.8) -&gt; 2036.4 (2083.3) MB, 790.0 / 0.0 ms  (average mu = 0.094, current mu = 0.036) allocation failure scavenge might not succeed<br></code></pre></td></tr></table></figure>

<p>垃圾回收 <code>Mark-sweep</code> 的范围始终是 2G 左右，<code>--max_old_space_size=12288</code> 设置的 12G 没有显示</p>
<h3 id="方案二：使用-increase-memory-limit-（由于某些原因我这不太好弄就没弄）"><a href="#方案二：使用-increase-memory-limit-（由于某些原因我这不太好弄就没弄）" class="headerlink" title="方案二：使用 increase-memory-limit （由于某些原因我这不太好弄就没弄）"></a>方案二：使用 <code>increase-memory-limit</code> （由于某些原因我这不太好弄就没弄）</h3><p>安装 <code>increase-memory-limit</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -save-dev increase-memory-limit<br></code></pre></td></tr></table></figure>

<p>安装 <code>cross-env</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -save-dev cross-env<br></code></pre></td></tr></table></figure>

<p>在 <code>package.json</code> 中添加</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&quot;scripts&quot;: &#123;<br>    &quot;fix-memory-limit&quot;: &quot;cross-env LIMIT=8192 increase-memory-limit&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译前运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run fix-memory-limit<br></code></pre></td></tr></table></figure>

<h3 id="方案三：在-docs-build-中添加-max-old-space-size-参数"><a href="#方案三：在-docs-build-中添加-max-old-space-size-参数" class="headerlink" title="方案三：在 docs:build 中添加 --max_old_space_size 参数"></a>方案三：在 <code>docs:build</code> 中添加 <code>--max_old_space_size</code> 参数</h3><p>Vuepress 的 <code>package.json</code> 中 <code>docs:build</code> 被封装</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&quot;scripts&quot;: &#123;<br>  &quot;docs:build&quot;: &quot;vuepress build docs&quot;<br>&#125;,<br></code></pre></td></tr></table></figure>

<p>直接在其中添加 <code>--max_old_space_size=8192</code> 会报找不到该参数的错，需要修改为如下格式</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&quot;scripts&quot;: &#123;<br>  &quot;docs:build&quot;: &quot;node --max_old_space_size=8192 xxx/xxx build&quot;<br>&#125;,<br></code></pre></td></tr></table></figure>

<p>此处直接修改 <code>node_modules/.bin/vuepress</code> ，在 <code>node  &quot;$basedir/../vuepress/cli.js&quot; &quot;$@&quot;</code> 中间增加 <code>--max_old_space_size=8192</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>basedir=$(dirname <span class="hljs-string">&quot;<span class="hljs-subst">$(echo <span class="hljs-string">&quot;<span class="hljs-variable">$0</span>&quot;</span> | sed -e &#x27;s,\\,/,g&#x27;)</span>&quot;</span>)<br><br><span class="hljs-keyword">case</span> `uname` <span class="hljs-keyword">in</span><br>    *CYGWIN*) basedir=`cygpath -w <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>&quot;</span>`;;<br><span class="hljs-keyword">esac</span><br><br><span class="hljs-keyword">if</span> [ -x <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>/node&quot;</span> ]; <span class="hljs-keyword">then</span><br>  <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>/node&quot;</span>  <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>/../vuepress/cli.js&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br>  ret=$?<br><span class="hljs-keyword">else</span><br>  node  --max_old_space_size=8192 <span class="hljs-string">&quot;<span class="hljs-variable">$basedir</span>/../vuepress/cli.js&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br>  ret=$?<br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">exit</span> <span class="hljs-variable">$ret</span><br></code></pre></td></tr></table></figure>

<p>终于编译成功不再报内存溢出错误了</p><div id="paginator"></div></div><div id="post-footer"><hr><a href="/2020/12/03/%E5%9F%BA%E4%BA%8E-Vue-Genesis-%E5%BE%AE%E5%89%8D%E7%AB%AF%E7%9A%84%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6%E5%8C%96/">← Prev 基于 Vue Genesis 微前端的前端插件化</a><span style="color: #fe2"> | </span><a href="/2020/10/18/Hexo-Github-Page%E6%90%AD%E5%BB%BA/">Hexo + Github Page 搭建 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/shanliangLS"> Dr.Shining</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">18</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">17</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">6</span></div></section></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-Vuepress-%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA"><span class="toc-number">1.</span> <span class="toc-text">编译 Vuepress 内存溢出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E4%BF%AE%E6%94%B9-NODE-OPTIONS"><span class="toc-number">1.1.</span> <span class="toc-text">方案一：修改 NODE_OPTIONS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E4%BD%BF%E7%94%A8-increase-memory-limit-%EF%BC%88%E7%94%B1%E4%BA%8E%E6%9F%90%E4%BA%9B%E5%8E%9F%E5%9B%A0%E6%88%91%E8%BF%99%E4%B8%8D%E5%A4%AA%E5%A5%BD%E5%BC%84%E5%B0%B1%E6%B2%A1%E5%BC%84%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">方案二：使用 increase-memory-limit （由于某些原因我这不太好弄就没弄）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E5%9C%A8-docs-build-%E4%B8%AD%E6%B7%BB%E5%8A%A0-max-old-space-size-%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">方案三：在 docs:build 中添加 --max_old_space_size 参数</span></a></li></ol></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">github.com/shanliangLS</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>