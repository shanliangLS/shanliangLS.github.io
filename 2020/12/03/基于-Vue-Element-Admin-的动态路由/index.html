<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>基于 Vue Element Admin 的动态路由 | 钐椋的博客</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.2.0"></head><body><header><nav><a href="/">首页</a><a href="/archives/">归档</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2020-12-03T02:44:48.000Z" id="date"> 2020-12-03</time></span><br><span>updated:<time datetime="2020-12-03T02:48:27.641Z" id="updated"> 2020-12-03</time></span></div><h1>基于 Vue Element Admin 的动态路由</h1><hr></div><div id="post-content"><p><a target="_blank" rel="noopener" href="https://panjiachen.gitee.io/vue-element-admin-site/zh/">vue element admin 官网</a></p>
<h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>侧边栏生成 <code>src/layout/components/Sidebar/index.vue</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;!-- ... --&gt;<br>    &lt;sidebar-item v-for&#x3D;&quot;route in permission_routes&quot; :key&#x3D;&quot;route.path&quot; :item&#x3D;&quot;route&quot; :base-path&#x3D;&quot;route.path&quot; &#x2F;&gt;<br>&lt;!-- ... --&gt;<br><br>&lt;script&gt;<br>import &#123; mapGetters &#125; from &#39;vuex&#39;<br>    <br>export default &#123;<br>  computed: &#123;<br>    ...mapGetters([<br>      &#39;permission_routes&#39;, &#x2F;&#x2F; permission_routes即为侧边栏路由数据，调用vuex获取<br>    ]),<br>    &#x2F;&#x2F; ...<br>  &#125;<br>&#125;<br>&lt;&#x2F;script&gt;<br></code></pre></td></tr></table></figure>

<p>侧边栏路由储存在 <code>src/store/modules/permission.js</code> 的 vuex 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; asyncRoutes, constantRoutes &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/router&#x27;</span> <span class="hljs-comment">// constantRoutes为常驻路由项，asyncRoutes为异步路由项，均从本地获取</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Use meta.role to determine if the current user has permission</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-variable">roles</span></span></span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-variable">route</span></span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasPermission</span>(<span class="hljs-params">roles, route</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (route.meta &amp;&amp; route.meta.roles) &#123;<br>    <span class="hljs-keyword">return</span> roles.some(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> route.meta.roles.includes(role))<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Filter asynchronous routing tables by recursion</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param </span>routes asyncRoutes</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param <span class="hljs-variable">roles</span></span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterAsyncRoutes</span>(<span class="hljs-params">routes, roles</span>) </span>&#123;<br>  <span class="hljs-keyword">const</span> res = []<br><br>  routes.forEach(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> tmp = &#123; ...route &#125;<br>    <span class="hljs-keyword">if</span> (hasPermission(roles, tmp)) &#123;<br>      <span class="hljs-keyword">if</span> (tmp.children) &#123;<br>        tmp.children = filterAsyncRoutes(tmp.children, roles)<br>      &#125;<br>      res.push(tmp)<br>    &#125;<br>  &#125;)<br><br>  <span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-keyword">const</span> state = &#123;<br>  routes: [],<br>  addRoutes: []<br>&#125;<br><br><span class="hljs-keyword">const</span> mutations = &#123; <span class="hljs-comment">// 将常驻路由项和异步路由项合并</span><br>  SET_ROUTES: <span class="hljs-function">(<span class="hljs-params">state, routes</span>) =&gt;</span> &#123;<br>    state.addRoutes = routes<br>    state.routes = constantRoutes.concat(routes)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> actions = &#123; <span class="hljs-comment">// 根据用户权限筛选异步路由项</span><br>  <span class="hljs-function"><span class="hljs-title">generateRoutes</span>(<span class="hljs-params">&#123; commit &#125;, roles</span>)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">let</span> accessedRoutes<br>      <span class="hljs-keyword">if</span> (roles.includes(<span class="hljs-string">&#x27;admin&#x27;</span>)) &#123;<br>        accessedRoutes = asyncRoutes || []<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        accessedRoutes = filterAsyncRoutes(asyncRoutes, roles)<br>      &#125;<br>      commit(<span class="hljs-string">&#x27;SET_ROUTES&#x27;</span>, accessedRoutes)<br>      resolve(accessedRoutes)<br>    &#125;)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  namespaced: <span class="hljs-literal">true</span>,<br>  state,<br>  mutations,<br>  actions<br>&#125;<br></code></pre></td></tr></table></figure>

<p>登录成功后 <code>src/permission.js</code> 首次触发路由生成</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./store&#x27;</span><br><br><span class="hljs-comment">// ...</span><br><br>router.beforeEach(<span class="hljs-keyword">async</span>(to, <span class="hljs-keyword">from</span>, next) =&gt; &#123;<br>    <span class="hljs-comment">// ...</span><br>    <br>    <span class="hljs-comment">// get user info</span><br>    <span class="hljs-comment">// note: roles must be a object array! such as: [&#x27;admin&#x27;] or ,[&#x27;developer&#x27;,&#x27;editor&#x27;]</span><br>    <span class="hljs-keyword">const</span> &#123; roles &#125; = <span class="hljs-keyword">await</span> store.dispatch(<span class="hljs-string">&#x27;user/getInfo&#x27;</span>)<br><br>    <span class="hljs-comment">// generate accessible routes map based on roles</span><br>    <span class="hljs-keyword">const</span> accessRoutes = <span class="hljs-keyword">await</span> store.dispatch(<span class="hljs-string">&#x27;permission/generateRoutes&#x27;</span>, roles)<br><br>    <span class="hljs-comment">// dynamically add accessible routes</span><br>    router.addRoutes(accessRoutes)<br><br>    <span class="hljs-comment">// hack method to ensure that addRoutes is complete</span><br>    <span class="hljs-comment">// set the replace: true, so the navigation will not leave a history record</span><br>    next(&#123; ...to, <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> &#125;)<br>    <br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><h3 id="mock"><a href="#mock" class="headerlink" title="mock"></a>mock</h3><p><code>mock/role</code> 目录下新建 <code>my-routes.js</code> 文件，格式参考 <code>src/router/index.js</code> ，<code>component</code> 属性改为字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> myAsyncRoutes = [<br>  &#123;<br>    path: <span class="hljs-string">&#x27;/plugins&#x27;</span>,<br>    component: <span class="hljs-string">&#x27;Layout&#x27;</span>,<br>    meta: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;插件&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;eye-open&#x27;</span> &#125;,<br>    children: [<br>      &#123;<br>        path: <span class="hljs-string">&#x27;PluginContainer/:src*&#x27;</span>, <span class="hljs-comment">// 动态路由匹配，将:src处的内容转化为路由参数$route.params</span><br>        component: <span class="hljs-string">&#x27;plugins/PluginContainer&#x27;</span>,<br>        name: <span class="hljs-string">&#x27;Plugins&#x27;</span>,<br>        meta: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;插件页&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;eye-open&#x27;</span> &#125;,<br>        hidden: <span class="hljs-literal">true</span><br>      &#125;,<br>      &#123;<br>        path: <span class="hljs-string">&#x27;PluginContainer/my-plugin&#x27;</span>,<br>        component: <span class="hljs-string">&#x27;plugins/PluginContainer&#x27;</span>,<br>        name: <span class="hljs-string">&#x27;my-plugin&#x27;</span>,<br>        meta: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;my-plugin&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;eye-open&#x27;</span> &#125;,<br>      &#125;,<br>      &#123;<br>        path: <span class="hljs-string">&#x27;PluginContainer/ssr-genesis&#x27;</span>,<br>        component: <span class="hljs-string">&#x27;plugins/PluginContainer&#x27;</span>,<br>        name: <span class="hljs-string">&#x27;ssr-genesis&#x27;</span>,<br>        meta: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;ssr-genesis&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;eye-open&#x27;</span> &#125;,<br>      &#125;<br>    ]<br>  &#125;,<br>  <br>  <span class="hljs-comment">/*&#123;</span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment">  &#125;,*/</span><br><br>  <span class="hljs-comment">// 404 page must be placed at the end !!!</span><br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/404&#x27;</span>, <span class="hljs-attr">hidden</span>: <span class="hljs-literal">true</span> &#125;<br>]<br><br><span class="hljs-built_in">module</span>.exports = &#123;<br>  myAsyncRoutes<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>mock/role/index.js</code> 引用 <code>my-routes.js</code> ，在 <code>module.exports</code> 中新增接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; myAsyncRoutes &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./my-routes.js&#x27;</span>)<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-built_in">module</span>.exports = [<br>  &#123;<br>    url: <span class="hljs-string">&#x27;/vue-element-admin/my-routes&#x27;</span>,<br>    type: <span class="hljs-string">&#x27;get&#x27;</span>,<br>    response: <span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        code: <span class="hljs-number">20000</span>,<br>        data: [<br>          &#123;<br>            name: <span class="hljs-string">&#x27;my-routes&#x27;</span>,<br>            title: <span class="hljs-string">&#x27;主菜单1&#x27;</span>,<br>            routes: myAsyncRoutes<br>          &#125;,<br>          &#123;<br>            name: <span class="hljs-string">&#x27;my-components&#x27;</span>,<br>            title: <span class="hljs-string">&#x27;组件2&#x27;</span>,<br>            routes: componentsRouter<br>          &#125;,<br>          &#123;<br>            name: <span class="hljs-string">&#x27;abc&#x27;</span>,<br>            title: <span class="hljs-string">&#x27;菜单3&#x27;</span>,<br>            routes: []<br>          &#125;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;,<br>    <br>  <span class="hljs-comment">/*&#123;</span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment">  &#125;,*/</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>src/api</code> 目录下新建 <code>menu.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/request&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getMyRoutes = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> request(&#123;<br>    url: <span class="hljs-string">&#x27;/vue-element-admin/my-routes&#x27;</span>,<br>    method: <span class="hljs-string">&#x27;get&#x27;</span><br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="路由生成"><a href="#路由生成" class="headerlink" title="路由生成"></a>路由生成</h3><p>修改 <code>src/store/modules/permission.js</code> ，从本地获取路由改为从接口获取路由，并增加对 <code>component</code> 属性的转换</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; constantRoutes &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/router&#x27;</span> <span class="hljs-comment">// 常驻路由项依旧从本地获取</span><br><span class="hljs-keyword">import</span> &#123; getMyRoutes &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/api/menu&#x27;</span> <span class="hljs-comment">// 异步路由项从接口获取</span><br><span class="hljs-keyword">import</span> Layout <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/layout/index&#x27;</span> <span class="hljs-comment">// Layout组件</span><br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterAsyncRoutesAddComponent</span>(<span class="hljs-params">asyncRouterMap</span>) </span>&#123; <span class="hljs-comment">// 遍历后台传来的路由字符串，转换为组件对象</span><br>  <span class="hljs-keyword">return</span> asyncRouterMap.filter(<span class="hljs-function"><span class="hljs-params">route</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (route.component) &#123;<br>      <span class="hljs-comment">// Layout组件特殊处理</span><br>      <span class="hljs-keyword">if</span> (route.component === <span class="hljs-string">&#x27;Layout&#x27;</span>) &#123;<br>        route.component = Layout<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        route.component = loadView(route.component)<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (route.children != <span class="hljs-literal">null</span> &amp;&amp; route.children &amp;&amp; route.children.length) &#123;<br>      route.children = filterAsyncRoutesAddComponent(route.children)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;)<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> loadView = <span class="hljs-function">(<span class="hljs-params">view</span>) =&gt;</span> &#123; <span class="hljs-comment">// 路由懒加载</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">require</span>([<span class="hljs-string">`@/views/<span class="hljs-subst">$&#123;view&#125;</span>`</span>], resolve)<br>&#125;<br><br><span class="hljs-keyword">const</span> state = &#123;<br>  totalRoutes: [], <span class="hljs-comment">// 所有路由数据</span><br>  routes: [],<br>  addRoutes: []<br>&#125;<br><br><span class="hljs-keyword">const</span> mutations = &#123;<br>  SET_TOTAL_ROUTES: <span class="hljs-function">(<span class="hljs-params">state, routes</span>) =&gt;</span> &#123; <span class="hljs-comment">// 储存从接口获取的所有路由数据</span><br>    state.totalRoutes = routes<br>  &#125;,<br>  SET_ROUTES: <span class="hljs-function">(<span class="hljs-params">state, routes</span>) =&gt;</span> &#123; <span class="hljs-comment">// 将常驻路由项和异步路由项合并</span><br>    state.addRoutes = routes<br>    state.routes = constantRoutes.concat(routes)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> actions = &#123;<br>  <span class="hljs-function"><span class="hljs-title">generateRoutes</span>(<span class="hljs-params">&#123; commit &#125;, &#123; roles, routesName = <span class="hljs-string">&#x27;my-routes&#x27;</span> &#125;</span>)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> &#123;<br>      <span class="hljs-comment">// 向后端请求路由数据</span><br>      getMyRoutes().then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">let</span> resolveRoutes = []<br>        <span class="hljs-keyword">const</span> filteredRoutes = res.data.filter(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> &#123;<br>          <span class="hljs-keyword">if</span> (roles.includes(<span class="hljs-string">&#x27;admin&#x27;</span>)) &#123; <span class="hljs-comment">// 根据用户权限筛选异步路由项</span><br>            item.routes = item.routes || []<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            item.routes = filterAsyncRoutes(item.routes, roles)<br>          &#125;<br>          item.routes = filterAsyncRoutesAddComponent(item.routes)<br>          resolveRoutes = [...resolveRoutes, ...item.routes]<br>          <span class="hljs-keyword">return</span> item<br>        &#125;)<br>        <span class="hljs-keyword">const</span> accessedRoutes = filteredRoutes.find(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.name === routesName).routes<br>        <span class="hljs-comment">// 路由项去重</span><br>        <span class="hljs-keyword">const</span> obj = &#123;&#125;<br>        resolveRoutes = resolveRoutes.reduce(<span class="hljs-function">(<span class="hljs-params">cur, next</span>) =&gt;</span> &#123;<br>          obj[next.path] ? <span class="hljs-string">&#x27;&#x27;</span> : obj[next.path] = <span class="hljs-literal">true</span> &amp;&amp; cur.push(next)<br>          <span class="hljs-keyword">return</span> cur<br>        &#125;, [])<br>        commit(<span class="hljs-string">&#x27;SET_TOTAL_ROUTES&#x27;</span>, filteredRoutes)<br>        commit(<span class="hljs-string">&#x27;SET_ROUTES&#x27;</span>, accessedRoutes)<br>        resolve(resolveRoutes)<br>      &#125;)<br>    &#125;)<br>  &#125;,<br>  <span class="hljs-function"><span class="hljs-title">updateSidebar</span>(<span class="hljs-params">&#123; commit &#125;, routesName = <span class="hljs-string">&#x27;my-routes&#x27;</span></span>)</span> &#123; <span class="hljs-comment">// 切换侧边栏</span><br>    <span class="hljs-keyword">const</span> accessedRoutes = state.totalRoutes.find(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.name === routesName).routes<br>    commit(<span class="hljs-string">&#x27;SET_ROUTES&#x27;</span>, accessedRoutes)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  namespaced: <span class="hljs-literal">true</span>,<br>  state,<br>  mutations,<br>  actions<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将 <code>src/permission.js</code> 的 <code>store.dispatch(&#39;permission/generateRoutes&#39;, roles)</code> 中的 <code>roles</code> 改为 <code>&#123;roles&#125;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./store&#x27;</span><br><br><span class="hljs-comment">// ...</span><br><br>router.beforeEach(<span class="hljs-keyword">async</span>(to, <span class="hljs-keyword">from</span>, next) =&gt; &#123;<br>    <span class="hljs-comment">// ...</span><br>    <br>    <span class="hljs-comment">// get user info</span><br>    <span class="hljs-comment">// note: roles must be a object array! such as: [&#x27;admin&#x27;] or ,[&#x27;developer&#x27;,&#x27;editor&#x27;]</span><br>    <span class="hljs-keyword">const</span> &#123; roles &#125; = <span class="hljs-keyword">await</span> store.dispatch(<span class="hljs-string">&#x27;user/getInfo&#x27;</span>)<br><br>    <span class="hljs-comment">// generate accessible routes map based on roles</span><br>    <span class="hljs-keyword">const</span> accessRoutes = <span class="hljs-keyword">await</span> store.dispatch(<span class="hljs-string">&#x27;permission/generateRoutes&#x27;</span>, &#123; roles &#125;)<br><br>    <span class="hljs-comment">// dynamically add accessible routes</span><br>    router.addRoutes(accessRoutes)<br><br>    <span class="hljs-comment">// hack method to ensure that addRoutes is complete</span><br>    <span class="hljs-comment">// set the replace: true, so the navigation will not leave a history record</span><br>    next(&#123; ...to, <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> &#125;)<br>    <br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>将 Vue Genesis 生成的 <code>client</code> 目录下的静态文件移动到 <code>public</code> 目录下。</p>
<p>在 <code>src/views</code> 目录下新建 <code>plugins/PluginContainer.vue</code> ，需安装 <code>npm install @fmfe/genesis-remote axios</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class&#x3D;&quot;plugin-container&quot;&gt;<br>    &lt;RemoteView :fetch&#x3D;&quot;fetch&quot; &#x2F;&gt;<br>  &lt;&#x2F;div&gt;<br>&lt;&#x2F;template&gt;<br><br>&lt;script&gt;<br>import axios from &#39;axios&#39;<br>import &#123; RemoteView &#125; from &#39;@fmfe&#x2F;genesis-remote&#39;<br><br>export default &#123;<br>  name: &#39;PluginContainer&#39;,<br>  components: &#123;<br>    RemoteView<br>  &#125;,<br>  data() &#123;<br>    return &#123;<br>      plugin_src: undefined,<br>      tempRoute: &#123;&#125;<br>    &#125;<br>  &#125;,<br>  created() &#123;<br>    this.plugin_src &#x3D; this.$route.params.src<br>    this.tempRoute &#x3D; Object.assign(&#123;&#125;, this.$route)<br>  &#125;,<br>  methods: &#123;<br>    async fetch() &#123;<br>      this.setTagsViewTitle() &#x2F;&#x2F; 设置导航栏标签<br>      this.setPageTitle() &#x2F;&#x2F; 设置页面标题<br>      const src &#x3D; this.plugin_src + &#39;&#x2F;app.json&#39;<br>      const res &#x3D; await axios.get(src) &#x2F;&#x2F; 获取ssr-genesis静态文件<br>      if (res.status &#x3D;&#x3D;&#x3D; 200) &#123;<br>        return res.data<br>      &#125;<br>      return null<br>    &#125;,<br>    setTagsViewTitle() &#123;<br>      const route &#x3D; Object.assign(&#123;&#125;, this.tempRoute, &#123; title: &#96;$&#123;this.plugin_src&#125;&#96; &#125;)<br>      this.$store.dispatch(&#39;tagsView&#x2F;updateVisitedView&#39;, route)<br>    &#125;,<br>    setPageTitle() &#123;<br>      document.title &#x3D; &#96;$&#123;this.plugin_src&#125;&#96;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;&#x2F;script&gt;<br></code></pre></td></tr></table></figure>

<h3 id="侧边栏路由切换"><a href="#侧边栏路由切换" class="headerlink" title="侧边栏路由切换"></a>侧边栏路由切换</h3><p>在 <code>src/components</code> 目录下新建 <code>TopMenu/index.vue</code>（未编写 CSS 样式）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;ul&gt;<br>    &lt;li v-for&#x3D;&quot;menu in menu_arr&quot;&gt;&lt;a @click&#x3D;&quot;updateRoutes(menu.name)&quot;&gt;&#123;&#123;menu.title&#125;&#125;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;<br>  &lt;&#x2F;ul&gt;<br>&lt;&#x2F;template&gt;<br><br>&lt;script&gt;<br>import store from &#39;..&#x2F;..&#x2F;store&#39;<br><br>export default &#123;<br>  name: &#39;TopMenu&#39;,<br>  data() &#123;<br>    return &#123;<br>      menu_arr: []<br>    &#125;<br>  &#125;,<br>  mounted() &#123; &#x2F;&#x2F; 获取存储的所有路由数据<br>    this.menu_arr &#x3D; store.state.permission.totalRoutes<br>  &#125;,<br>  methods: &#123;<br>    updateRoutes(routesName) &#123; &#x2F;&#x2F; 切换侧边栏路由<br>      store.dispatch(&#39;permission&#x2F;updateSidebar&#39;, routesName)<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;&#x2F;script&gt;<br><br>&lt;style lang&#x3D;&quot;scss&quot; scoped&gt;<br>ul &#123;<br>  padding-left: 0;<br><br>  li &#123;<br>    margin-left: 8px;<br>    display: inline;<br>    float:left<br>  &#125;<br>&#125;<br>&lt;&#x2F;style&gt;<br></code></pre></td></tr></table></figure>

<p><code>src/layout/components/Navbar.vue</code> 中，在 <code>&lt;hamburger&gt;</code> 和 <code>&lt;breadcrumb&gt;</code> 中间插入切换侧边栏的菜单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class&#x3D;&quot;navbar&quot;&gt;<br>    &lt;hamburger id&#x3D;&quot;hamburger-container&quot; :is-active&#x3D;&quot;sidebar.opened&quot; class&#x3D;&quot;hamburger-container&quot; @toggleClick&#x3D;&quot;toggleSideBar&quot; &#x2F;&gt;<br><br>    &lt;top-menu class&#x3D;&quot;top-menu-container&quot; &#x2F;&gt;<br><br>    &lt;breadcrumb id&#x3D;&quot;breadcrumb-container&quot; class&#x3D;&quot;breadcrumb-container&quot; &#x2F;&gt;<br>    &lt;!-- ... --&gt;<br>  &lt;&#x2F;div&gt;<br>&lt;&#x2F;template&gt;<br><br>&lt;script&gt;<br>import TopMenu from &#39;@&#x2F;components&#x2F;TopMenu&#39;<br>    <br>export default &#123;<br>  components: &#123;<br>    TopMenu<br>  &#125;<br>  &#x2F;&#x2F; ...<br>&#125;<br>&lt;&#x2F;script&gt;<br><br>&lt;style lang&#x3D;&quot;scss&quot; scoped&gt;<br>.navbar &#123;<br>  &#x2F;* ... *&#x2F;<br>  .top-menu-container &#123;<br>    float: left;<br>  &#125;<br>  &#x2F;* ... *&#x2F;<br>&#125;<br>&lt;&#x2F;style&gt;<br></code></pre></td></tr></table></figure>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2020/12/03/%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7-Cypress/">← Prev 前端自动化测试工具 Cypress</a><span style="color: #fe2"> | </span><a href="/2020/12/03/%E5%9F%BA%E4%BA%8E-Vue-Genesis-%E5%BE%AE%E5%89%8D%E7%AB%AF%E7%9A%84%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6%E5%8C%96/">基于 Vue Genesis 微前端的前端插件化 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a target="_blank" rel="noopener" href="https://github.com/shanliangLS"> Dr.Shining</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">18</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">17</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">6</span></div></section></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">源代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">2.</span> <span class="toc-text">修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mock"><span class="toc-number">2.1.</span> <span class="toc-text">mock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%94%9F%E6%88%90"><span class="toc-number">2.2.</span> <span class="toc-text">路由生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%A7%E8%BE%B9%E6%A0%8F%E8%B7%AF%E7%94%B1%E5%88%87%E6%8D%A2"><span class="toc-number">2.3.</span> <span class="toc-text">侧边栏路由切换</span></a></li></ol></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">github.com/shanliangLS</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>